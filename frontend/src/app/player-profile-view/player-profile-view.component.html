<app-page-header
  title="Player Profile"
  [descriptionParagraphs]="['Individual Player Statistics and Performance']"
></app-page-header>

<div class="player-profile-container">
  <!-- Loading State -->
  <div *ngIf="isLoading" class="loading-container">
    <div class="loading-spinner"></div>
    <p>Loading player profile...</p>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !isLoading" class="error-container">
    <h3>Error</h3>
    <p>{{ error }}</p>
    <button (click)="loadPlayerProfile()" class="retry-button">Retry</button>
  </div>

  <!-- Player Profile Content -->
  <div *ngIf="!isLoading && !error" class="profile-content">
    <!-- Player Header Section -->
    <div class="player-header">
      <div class="player-avatar-section">
        <img 
          [src]="playerData.avatarUrl || '/assets/default-avatar.png'" 
          [alt]="playerData.username + ' avatar'"
          class="player-avatar-large"
          onerror="this.src='/assets/default-avatar.png'"
        />
      </div>
      
      <div class="player-info-section">
        <div class="player-flag-container">
          <img 
            *ngIf="getCountryFlag(playerData.countryCode, playerData.stateCode)"
            [src]="getCountryFlag(playerData.countryCode, playerData.stateCode)" 
            [alt]="getFlagAltText(playerData.countryCode, playerData.stateCode)"
            class="player-flag-large"
            onerror="this.style.display='none'"
          />
        </div>
        <h1 class="player-name">{{ playerData.username }}</h1>
        <div class="player-elo">
          <span class="elo-label">ELO:</span>
          <span class="elo-value">{{ playerData.currentElo || 1000 }}</span>
        </div>
        <p class="steam-id">Steam ID: {{ steamId }}</p>
      </div>
    </div>

    <!-- Stats Section with Tabs -->
    <div class="stats-section">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'overview'"
          (click)="switchTab('overview')"
        >
          Overview
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'maps'"
          (click)="switchTab('maps')"
        >
          Maps & Modes
        </button>
        <button 
          class="tab-button" 
          [class.active]="activeTab === 'charts'"
          (click)="switchTab('charts')"
        >
          Charts
        </button>
      </div>

      <!-- Tab Content -->
      <div class="tab-content">
        <!-- Overview Tab -->
        <div *ngIf="activeTab === 'overview'" class="overview-tab">
          <div *ngIf="aggregatedStats" class="stats-grid">
            <!-- Win/Loss Record -->
            <div class="stat-card">
              <h3>Win/Loss Record</h3>
              <div class="stat-row">
                <span class="stat-label">Games Played:</span>
                <span class="stat-value">{{ aggregatedStats.totalGames }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Wins:</span>
                <span class="stat-value wins">{{ aggregatedStats.wins }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Losses:</span>
                <span class="stat-value losses">{{ aggregatedStats.losses }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Win Rate:</span>
                <span class="stat-value">{{ aggregatedStats.winrate }}%</span>
              </div>
            </div>

            <!-- ELO Changes -->
            <div class="stat-card">
              <h3>ELO Performance</h3>
              <div class="stat-row">
                <span class="stat-label">Total ELO Gained:</span>
                <span class="stat-value elo-gained">+{{ aggregatedStats.totalEloGained }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Total ELO Lost:</span>
                <span class="stat-value elo-lost">-{{ aggregatedStats.totalEloLost }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Net ELO Change:</span>
                <span class="stat-value" [class.elo-gained]="aggregatedStats.netEloChange >= 0" [class.elo-lost]="aggregatedStats.netEloChange < 0">
                  {{ aggregatedStats.netEloChange >= 0 ? '+' : '' }}{{ aggregatedStats.netEloChange }}
                </span>
              </div>
            </div>

            <!-- Combat Stats -->
            <div class="stat-card">
              <h3>Combat Performance</h3>
              <div class="stat-row">
                <span class="stat-label">K/D Ratio:</span>
                <span class="stat-value">{{ aggregatedStats.kdr }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">ADR:</span>
                <span class="stat-value">{{ aggregatedStats.adr }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Total Kills:</span>
                <span class="stat-value">{{ aggregatedStats.kills }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Total Deaths:</span>
                <span class="stat-value">{{ aggregatedStats.deaths }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Total Assists:</span>
                <span class="stat-value">{{ aggregatedStats.assists }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Headshot %:</span>
                <span class="stat-value">{{ aggregatedStats.headShotPercentage }}%</span>
              </div>
            </div>

            <!-- Accuracy & Entry Stats -->
            <div class="stat-card">
              <h3>Accuracy & Entry</h3>
              <div class="stat-row">
                <span class="stat-label">Accuracy:</span>
                <span class="stat-value">{{ aggregatedStats.accuracy }}%</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Entry Win Rate:</span>
                <span class="stat-value">{{ aggregatedStats.entryWinRate }}%</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Total Damage:</span>
                <span class="stat-value">{{ aggregatedStats.damage.toLocaleString() }}</span>
              </div>
              <div class="stat-row">
                <span class="stat-label">Total Rounds:</span>
                <span class="stat-value">{{ aggregatedStats.totalRounds }}</span>
              </div>
            </div>
          </div>

          <div *ngIf="!aggregatedStats" class="no-stats">
            <p>ðŸ“Š No statistics available</p>
            <p>This player hasn't completed any matches yet.</p>
          </div>
        </div>

        <!-- Maps & Modes Tab -->
        <div *ngIf="activeTab === 'maps'" class="maps-tab">
          <!-- Game Modes Section -->
          <div class="gamemode-section">
            <h3>Game Modes</h3>
            <div *ngIf="gameModeStats.length > 0" class="gamemode-list">
              <div 
                *ngFor="let mode of gameModeStats" 
                class="gamemode-card"
              >
                <div class="gamemode-info">
                  <h4>{{ mode.displayName }}</h4>
                  <div class="gamemode-stats">
                    <span class="games-count">{{ mode.gamesPlayed }} games</span>
                    <span class="winrate">{{ mode.winrate }}% win rate</span>
                  </div>
                  <div class="win-loss-bar">
                    <div class="wins-bar" [style.width.%]="(mode.wins / mode.gamesPlayed) * 100"></div>
                    <div class="losses-bar" [style.width.%]="(mode.losses / mode.gamesPlayed) * 100"></div>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="gameModeStats.length === 0" class="no-data">
              <p>No gamemode data available</p>
            </div>
          </div>

          <!-- Maps Section -->
          <div class="maps-section">
            <h3>Most Played Maps</h3>
            <div *ngIf="mapStats.length > 0" class="maps-grid">
              <div 
                *ngFor="let map of mapStats" 
                class="map-card clickable"
                [style.background-image]="'url(' + map.mapThumbnailUrl + ')'"
                (click)="openMapWorkshop(map.mapWorkshopUrl || '')"
                title="Click to view in Steam Workshop"
              >
                <div class="map-overlay">
                  <div class="map-info">
                    <h4>{{ map.mapName }}</h4>
                    <div class="map-stats">
                      <div class="games-played">{{ map.gamesPlayed }} games</div>
                      <div class="map-winrate">{{ map.winrate }}% win rate</div>
                      <div class="win-loss-detail">
                        <span class="wins">{{ map.wins }}W</span>
                        <span class="losses">{{ map.losses }}L</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div *ngIf="mapStats.length === 0" class="no-data">
              <p>No map data available</p>
            </div>
          </div>
        </div>

        <!-- Charts Tab -->
        <div *ngIf="activeTab === 'charts'" class="charts-tab">
          <div class="chart-controls">
            <div class="dropdown-container">
              <label for="chart-type-select">Select Data:</label>
              <select 
                id="chart-type-select"
                [(ngModel)]="selectedChartType" 
                (change)="onChartTypeChange(selectedChartType)"
                class="chart-dropdown"
              >
                <option value="" disabled>Select Data</option>
                <option value="cumulative-wins-losses">Cumulative Wins/Losses</option>
                <option value="elo">ELO</option>
              </select>
            </div>
          </div>

          <div class="chart-container">
            <div *ngIf="!selectedChartType" class="chart-placeholder">
              <p>ðŸ“Š Select a data type to view the chart</p>
            </div>

            <div *ngIf="selectedChartType === 'cumulative-wins-losses'" class="chart-content">
              <h4>Cumulative Wins/Losses Over Time</h4>
              <div class="chart-wrapper">
                <canvas 
                  #chartCanvas 
                  id="winLossChart"
                  width="800" 
                  height="400"
                ></canvas>
              </div>
            </div>

            <div *ngIf="selectedChartType === 'elo'" class="chart-content">
              <h4>ELO Changes Over Time</h4>
              <div class="chart-wrapper">
                <canvas 
                  #chartCanvas 
                  id="eloChart"
                  width="800" 
                  height="400"
                ></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
