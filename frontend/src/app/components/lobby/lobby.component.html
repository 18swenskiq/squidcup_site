<div class="lobby-container">
  <div class="lobby-header">
    <h2>Game Lobby</h2>
    <div class="lobby-info">
      <span class="gamemode">{{ lobby.gameMode }}</span>
      <span class="ranked" *ngIf="lobby.ranked">Ranked</span>
      <span class="map-mode">{{ lobby.mapSelectionMode }}</span>
    </div>
  </div>

  <!-- Teams Display - Two teams with selected map in between -->
  <div class="teams-container">
    <!-- Team 1 -->
    <div class="team">
      <h3>{{ getTeamName(1) }}</h3>
      <div class="players-list">
        <div class="player" *ngFor="let player of getTeamPlayers(1)">
          <span class="player-name">{{ getPlayerDisplayName(player.steamId) }}</span>
          <span class="host-badge" *ngIf="player.steamId === lobby.hostSteamId">Host</span>
          <span class="map-status" *ngIf="lobby.mapSelectionMode === 'all-pick'">
            {{ player.hasSelectedMap ? '‚úì Selected' : '‚è≥ Selecting...' }}
          </span>
        </div>
        <!-- Show empty slots if team has no players -->
        <div class="player empty-slot" *ngIf="getTeamPlayers(1).length === 0">
          <span class="player-name">Waiting for players...</span>
        </div>
      </div>
    </div>

    <!-- Selected Map Display (Center) -->
    <div class="selected-map-display">
      <h4>Selected:</h4>
      <div class="map-name" *ngIf="lobby.selectedMap && isMapSelectionComplete; else noMapSelected">
        {{ getSelectedMapName() }}
      </div>
      <ng-template #noMapSelected>
        <div class="map-name no-selection">
          {{ getMapSelectionStatus() }}
        </div>
      </ng-template>
    </div>

    <!-- Team 2 -->
    <div class="team">
      <h3>{{ getTeamName(2) }}</h3>
      <div class="players-list">
        <div class="player" *ngFor="let player of getTeamPlayers(2)">
          <span class="player-name">{{ getPlayerDisplayName(player.steamId) }}</span>
          <span class="host-badge" *ngIf="player.steamId === lobby.hostSteamId">Host</span>
          <span class="map-status" *ngIf="lobby.mapSelectionMode === 'all-pick'">
            {{ player.hasSelectedMap ? '‚úì Selected' : '‚è≥ Selecting...' }}
          </span>
        </div>
        <!-- Show empty slots if team has no players -->
        <div class="player empty-slot" *ngIf="getTeamPlayers(2).length === 0">
          <span class="player-name">Waiting for players...</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Map Selection Section -->
  <div class="map-selection" *ngIf="!lobby.mapSelectionComplete">
    <h3>Map Selection</h3>
    
    <!-- Random Map Mode -->
    <div *ngIf="lobby.mapSelectionMode === 'Random Map'" class="map-info">
      <p>üé≤ A random map will be selected automatically</p>
    </div>

    <!-- Host Pick Mode -->
    <div *ngIf="lobby.mapSelectionMode === 'Host Pick'" class="map-picker">
      <div *ngIf="isHost">
        <p>As the host, please select a map:</p>
        
        <!-- Loading spinner -->
        <div *ngIf="mapsLoading" class="maps-loading">
          <div class="spinner"></div>
          <p>Loading available maps...</p>
        </div>
        
        <!-- Map selection form -->
        <form *ngIf="!mapsLoading" [formGroup]="mapSelectionForm" (ngSubmit)="selectMap()">
          <div class="map-tiles">
            <div 
              *ngFor="let map of availableMaps" 
              class="map-tile"
              [class.selected]="mapSelectionForm.get('selectedMap')?.value === map.id"
              [style.background-image]="'url(' + map.thumbnailUrl + ')'"
              (click)="selectMapTile(map.id)">
              <div class="map-name">{{ map.name }}</div>
            </div>
          </div>
          <button type="submit" [disabled]="!mapSelectionForm.get('selectedMap')?.value" class="select-btn">
            Select Map
          </button>
        </form>
      </div>
      <div *ngIf="!isHost">
        <p>‚è≥ Waiting for host to select a map...</p>
      </div>
    </div>

    <!-- All Pick Mode -->
    <div *ngIf="lobby.mapSelectionMode === 'all-pick'" class="map-picker">
      <div *ngIf="canSelectMap()">
        <p>Please select your preferred map:</p>
        
        <!-- Loading spinner -->
        <div *ngIf="mapsLoading" class="maps-loading">
          <div class="spinner"></div>
          <p>Loading available maps...</p>
        </div>
        
        <!-- Map selection form -->
        <form *ngIf="!mapsLoading" [formGroup]="mapSelectionForm" (ngSubmit)="selectMap()">
          <div class="map-tiles">
            <div 
              *ngFor="let map of availableMaps" 
              class="map-tile"
              [class.selected]="mapSelectionForm.get('selectedMap')?.value === map.id"
              [style.background-image]="'url(' + map.thumbnailUrl + ')'"
              (click)="selectMapTile(map.id)">
              <div class="map-name">{{ map.name }}</div>
            </div>
          </div>
          <button type="submit" [disabled]="!mapSelectionForm.get('selectedMap')?.value" class="select-btn">
            Select Map
          </button>
        </form>
      </div>
      <div *ngIf="!canSelectMap()">
        <p>‚è≥ Waiting for all players to make their map selections...</p>
        <div class="selection-progress">
          <span>{{ playersWithMapSelection }} / {{ totalPlayers }} players selected</span>
        </div>
      </div>
    </div>

    <!-- Fallback: Show map tiles if we have maps but no mode matched -->
    <div *ngIf="availableMaps.length > 0 && 
                lobby.mapSelectionMode !== 'Random Map' && 
                lobby.mapSelectionMode !== 'Host Pick' && 
                lobby.mapSelectionMode !== 'All Pick' && 
                lobby.mapSelectionMode !== 'all-pick'" class="map-picker">
      <p>Select a map ({{ lobby.mapSelectionMode }}):</p>
      
      <!-- Loading spinner -->
      <div *ngIf="mapsLoading" class="maps-loading">
        <div class="spinner"></div>
        <p>Loading available maps...</p>
      </div>
      
      <!-- Map selection form -->
      <form *ngIf="!mapsLoading" [formGroup]="mapSelectionForm" (ngSubmit)="selectMap()">
        <div class="map-tiles">
          <div 
            *ngFor="let map of availableMaps" 
            class="map-tile"
            [class.selected]="mapSelectionForm.get('selectedMap')?.value === map.id"
            [style.background-image]="'url(' + map.thumbnailUrl + ')'"
            (click)="selectMapTile(map.id)">
            <div class="map-name">{{ map.name }}</div>
          </div>
        </div>
        <button type="submit" [disabled]="!mapSelectionForm.get('selectedMap')?.value" class="select-btn">
          Select Map
        </button>
      </form>
    </div>
  </div>

  <!-- Selected Map Display -->
  <div class="selected-map" *ngIf="isMapSelectionComplete && lobby.selectedMap">
    <h3>Selected Map</h3>
    <div class="map-info">
      <span class="map-name">{{ selectedMapName }}</span>
    </div>
  </div>

  <!-- Game Ready Status -->
  <div class="game-status" *ngIf="isMapSelectionComplete">
    <div class="status-message">
      <h3>üéÆ Game Ready!</h3>
      <p>All players are ready and the map has been selected. The game can now begin!</p>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="lobby-actions">
    <button class="leave-btn danger" (click)="leaveLobby()">
      Leave Lobby
    </button>
  </div>
</div>
